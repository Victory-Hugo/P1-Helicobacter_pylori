
library(bugwas)
# install.packages("https://raw.githubusercontent.com/sgearle/bugwas/master/build/bugwas_1.0.tar.gz", repos=NULL, type="source")
gen <- "geno_biallelic_SNP.txt"  # Genotype file generated by s4_input_bugwas.py
pheno <- "pheno.txt"  # Phenotype file
phylo <- "treeFull.nwk"  # Phylogenetic tree file
prefix <- "bugwas"  # Prefix for result files
gem.path <- "./gemma"  # Path to the GEMMA binary

data <- lin_loc(
  gen = gen, 
  pheno = pheno, 
  phylo = phylo, 
  prefix = prefix, 
  gem.path = gem.path, 
  creatingAllPlots = FALSE
)  # Run GWAS analysis

# save(data, file = "data_GWAS.RData")  # Save GWAS analysis output

all_plots(
  biallelic = data$biallelic, 
  triallelic = data$triallelic, 
  genVars = data$genVars, 
  treeInfo = data$treeInfo, 
  config = data$config
)  # Generate figures

###################################
## Post-processing
###################################

library(ggplot2)
library(readr)

##############################
# 1. Read and process the GFF file
##############################
# Check whether the GFF file exists
gff_file <- "NC_000915.gff"
if (!file.exists(gff_file)) {
  stop("GFF file not found. Please verify the path.")
}

# Read the GFF file while skipping the first two comment lines
gff_temp <- read_delim(
  gff_file,
  delim = "\t",
  escape_double = FALSE,
  col_names = FALSE,
  trim_ws = TRUE,
  skip = 2
)


# Specify column names
colnames(gff_temp) <- c("seq_id", "source", "type", "start", "end", 
                        "score", "strand", "phase", "attributes")

# Convert to a data frame and ensure coordinates are numeric
gff_df <- as.data.frame(gff_temp)
gff_df$start <- as.numeric(gff_df$start)
gff_df$end   <- as.numeric(gff_df$end)

# Split CDS and non-CDS entries
gff_CDS   <- gff_df[gff_df$type == "CDS", ]
gff_nonCDS <- gff_df[gff_df$type != "CDS", ]

##############################
# 2. Load GWAS analysis results
##############################
# Ensure that "bugwas_biallelic_lmmout_allSNPs.txt" contains the ps and negLog10 columns
# Adjust the separator based on your actual file (tab-delimited here)
data <- read.table('bugwas_biallelic_lmmout_allSNPs.txt', header = TRUE, sep = "\t", stringsAsFactors = FALSE)

# Recalculate -log10(p_lrt) and update the negLog10 column
data$negLog10 <- -log10(data$p_lrt)

# Write results back out (tab-delimited without row names)
write.table(data, file = 'bugwas_biallelic_lmmout_allSNPs.txt', sep = "\t", row.names = FALSE, quote = FALSE)
# If the separator differs, add sep="\t" or another delimiter
gwas_data <- read.table("bugwas_biallelic_lmmout_allSNPs.txt", 
                        header = TRUE, stringsAsFactors = FALSE)
