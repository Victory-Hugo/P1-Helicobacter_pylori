# 2-variant: Variant Splitting and Frequency Analysis

This directory contains configuration files and scripts for splitting a merged VCF into region-specific VCFs and performing variant-frequency based statistics for *Helicobacter pylori* samples.

The pipeline assumes that a merged multi-sample VCF has already been generated upstream (e.g. in `1-nucmer`) and focuses on:
- Creating per-region VCF files based on sample lists.
- Calculating variant counts and frequency categories.
- Producing summary tables and files suitable for Venn diagram analyses.

## Directory Structure

- `conf/`
  - `Example.txt`: Example sample list file. Each line typically contains a sample ID to be extracted from the merged VCF. You can create additional `.txt` files here for different regions or groups (e.g. `Africa.txt`, `Europe.txt`, etc.).

- `script/`
  - `1-Split_VCF.sh`: Splits a merged multi-sample VCF into multiple region/group-specific VCFs using sample lists in `conf/`.
  - `2-Variant_count.sh`: For each region-specific VCF, computes variant counts, allele-frequency based categories, and private variants, and generates summary tables and Venn-diagram-friendly files.
  - `GCA_*`: Additional helper scripts or placeholders (if any) specific to certain datasets or accessions.
  - `3-Freq_vis.R`: Visualizes variant frequency summaries (e.g. category-wise counts and group-wise comparisons) as bar plots using `tidyplots`.
  - `4-MAF_vis.R`: Visualizes minor allele frequency (MAF) bin distributions from the `1-Variants-stat` module.
  - `8-Indi_vis.R`: Visualizes per-individual variant counts (variants per genome) as boxplots and beeswarm plots.

- (Created at runtime)
  - `data/`: Output directory for region-specific VCF files generated by `1-Split_VCF.sh`.
  - `output/`: Output directory for summary statistics generated by `2-Variant_count.sh`.

## Prerequisites

- `bcftools` installed and available in `PATH`.
- `GNU parallel` installed for parallel sample splitting.
- A merged, bgzipped and indexed VCF file produced upstream:
  - Expected path: `../1-nucmer/output/merge/merged_biallelic.7544.vcf.gz` (relative to this `2-variant` directory).

## Workflow Overview

1. **Prepare sample lists**
   - Create one or more `.txt` files in `conf/`, each listing sample IDs (one per line) corresponding to a region or group.

2. **Split the merged VCF by region/group**
   - Script: `script/1-Split_VCF.sh`
   - Behavior:
     - Reads all `.txt` files in `conf/`.
     - For each file (e.g. `Asia.txt`), runs `bcftools view -S` to extract the listed samples from the merged VCF.
     - Writes compressed VCFs into `data/`, named `<Region>.vcf.gz` (e.g. `Asia.vcf.gz`).

   - Example run:
     ```bash
     cd 2-variant
     bash script/1-Split_VCF.sh
     ```

3. **Compute variant statistics and private variants**
   - Script: `script/2-Variant_count.sh`
   - Behavior:
     - Loops over all `*.vcf.gz` files in `data/`.
     - For each region:
       - Counts total variants (`bcftools view -H | wc -l`).
       - Extracts allele counts (`AC`) and total alleles (`AN`) via `bcftools query`.
       - Calculates minor allele frequency (MAF) and classifies variants into:
         - Common (MAF > 0.05)
         - Low-frequency (0.01 < MAF ≤ 0.05)
         - Rare (MAF ≤ 0.01)
         - Singleton (AC = 1)
         - Doubleton (AC = 2)
       - Saves per-region variant IDs into files under `output/venn_data/` for Venn diagrams.
       - Identifies private variants (present only in one region) and records counts.
     - Writes:
       - `output/variant_summary.tsv`: Tab-delimited summary table.
       - `output/variant_summary_formatted.tsv`: Column-aligned version for easier viewing.
       - `output/variant_stats.log`: Log file with processing messages and per-category counts.

   - Example run:
     ```bash
     cd 2-variant
     bash script/2-Variant_count.sh
     ```

4. **Visualize variant-frequency related summaries**

   - **Variant frequency categories and group comparisons**
     - Script: `script/3-Freq_vis.R`
     - Expected input (relative to `2-variant`):
       - `output/compare_eas_global/csv/Global.csv`
     - Behavior:
       - Reads `Global.csv` and converts it to a tibble.
       - Produces several bar plots:
         - Overall variant statistics across classes.
         - Variant statistics split by `Source` (e.g. East Asia vs Global).
         - Overall SNP/INDEL statistics.
         - SNP/INDEL statistics split by `Source`.
       - Saves PDF files in the current working directory with descriptive English filenames
         (e.g. `overall_variant_statistics.pdf`, `variant_statistics_by_group.pdf`).

   - **MAF bin distribution**
     - Script: `script/4-MAF_vis.R`
     - Expected input:
       - `../../1-Variants-stat/output/Bin_MAF_Comparison.csv`
         (relative to `2-variant/script`, i.e. from within the script directory).
     - Behavior:
       - Reads binned MAF comparison data and reshapes it from wide to long format.
       - Ensures MAF bins follow a predefined order.
       - Draws stacked bar plots showing counts per MAF bin and `Source`.
       - Saves the PDF `MAF_distribution.pdf` in the current working directory.

   - **Per-individual variant counts**
     - Script: `script/8-Indi_vis.R`
     - Expected input directory (relative to `2-variant/script`):
       - `../output/subset/`
         containing multiple CSV files; each CSV must have columns:
         - `sample`
         - `variant_count` (per-genome variant count)
         - `Source` (group/category)
     - Behavior:
       - Reads all CSV files in `../output/subset/` and combines them.
       - Scales `variant_count` by 1000 to plot “Variants per genome (K)”.
       - Produces:
         - A boxplot with jittered points.
         - A boxplot with beeswarm points.
       - Both plots are colored by `Source` and use English axis titles.
       - Saves PDFs named `Boxplot.pdf` in the current working directory (one per plotting call).

## Notes

- All paths inside the scripts are relative to the script locations, so you can move the project directory without changing the code, as long as the relative structure between `1-nucmer` and `2-variant` is preserved.
- To adapt the pipeline to other datasets, update:
  - The merged VCF path in `script/1-Split_VCF.sh` if your upstream file name or location differs.
  - The sample list files in `conf/` to match your new sample IDs and regions.
